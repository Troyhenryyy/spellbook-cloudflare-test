---
import Layout from '../layouts/Layout.astro';
import SpellBrowser from '../components/SpellBrowser.tsx';
import { slugify } from '../utils/slugify';


const spellFiles = import.meta.glob('../../data/spells/spells-*.json', { eager: true });


// Helper to flatten the complex 5e.tools text arrays into a single string
function extractText(entries: any): string {
  if (!entries) return '';
  if (typeof entries === 'string') return entries;
  if (Array.isArray(entries)) return entries.map(extractText).join('\n'); 
  if (typeof entries === 'object' && entries.entries) return extractText(entries.entries);
  return '';
}


let allSpellsRaw: any[] = [];

for (const path in spellFiles) {
  const fileData = spellFiles[path] as any;
 
  const list = fileData.spell || [];
  allSpellsRaw = [...allSpellsRaw, ...list];
}


const uniqueSpellsMap = new Map();

allSpellsRaw.forEach((spell) => {

  if (!uniqueSpellsMap.has(spell.name)) {
    uniqueSpellsMap.set(spell.name, spell);
  }
});


const uniqueSpellsArray = Array.from(uniqueSpellsMap.values());


const allSpells = uniqueSpellsArray.map((s: any) => ({
  name: s.name,
  slug: slugify(s.name),
  level: s.level,
  school: s.school,

  time: s.time,
  concentration: s.concentration,
  range: s.range,
  source: s.source,
  description: extractText(s.entries) 
}));


allSpells.sort((a, b) => a.name.localeCompare(b.name));
---

<Layout title="Astro Spellbook Showdown">
  <main class="min-h-screen bg-slate-50 py-10 px-4">
    
    {/* Header Section */}
    <div class="max-w-6xl mx-auto mb-10 text-center">
      <h1 class="text-5xl font-serif font-bold text-slate-900 mb-2 tracking-tight">
        Unsealed Spellbook V4 port 80
      </h1>
      <p class="text-slate-600 font-medium">Def not the League Rune</p>
    </div>
    <SpellBrowser client:load initialSpells={allSpells} />

  </main>
</Layout>